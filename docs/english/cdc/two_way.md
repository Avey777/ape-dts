# Introduction
- In a distributed system, the source database and the target database are not necessarily a simple master-standby, sometimes they can independently accept data changes, but data sync is also needed to ensure that they both have complete data.
- To enable two-way data sync, we need cdc tasks for both "source -> target" and "target -> source" 

# Cyclic data sync
- The main difficulty for two-way data sync is how to avoid cyclic copying, consider the following scenario:
    - A record "A" is inserted into source mysql, and the cdc task "source -> target" synced it into target
    - A binlog record for inserting "A" is generated in target mysql
    - Cdc task "target -> source" pulls the binlog for record "A", and sync it to source

# Topology
- In fact, when it comes to two-way or even net data sync, it can be considered as a topology:
    - Databases that need to be synced with each other form a logical cluster, and each database is a node
    - One or more data sync tasks to connect databases, each task is a side
    - Topology = database nodes + tasks

## Topology example
<div align=center>
<img src="../../pics/topo_two_way.png" width="55%" />
<br/>
two-way topology
</div>

***

<div align=center>
<img src="../../pics/topo_net.png"/>
<br/>
net topology
</div>

***

<div align=center>
<img src="../../pics/topo_star.png"/>
<br/>
star topology
</div>

***

# Data marker
- We use data marker to avoid cyclic data sync

## Explain
- Assume that in a mysql two-way topology, there are two tasks:
    - task1 (source: node1, target: node2)
    - task2 (source: node2, target: node1)
- When task1 writes data to node2, the data original source will be marked through the data marker table and recorded in the binlog of node2
- When task2 parses the binlog from node2, it finds out that some binlogs were generated by task1, and the original source of the data is node1, so it gave up these data to avoid cyclic data sync

## marker table
- In order to mark cdc data, the target database needs an additional marker table, mark info is actually written to binlog(mysql) /wal(pg) / aof(redis) by updating the marker table
- If data marker configured but table not created, cdc task will try to create it, which needs the sinker account to have create privileges

### mysql
```
CREATE TABLE IF NOT EXISTS `{}`.`{}` (
    data_origin_node varchar(255) NOT NULL,
    src_node varchar(255) NOT NULL,
    dst_node varchar(255) NOT NULL,
    n bigint DEFAULT NULL,
    PRIMARY KEY (data_origin_node, src_node, dst_node)
)
```

### pg
```
CREATE TABLE IF NOT EXISTS "{}"."{}" (
    data_origin_node varchar(255) NOT NULL,
    src_node varchar(255) NOT NULL,
    dst_node varchar(255) NOT NULL,
    n bigint DEFAULT NULL,
    PRIMARY KEY (data_origin_node, src_node, dst_node)
)
```

### redis
- The redis mark info is written to the target aof by updating the redis key, no need to pre-create anything


# Config
- Add [data_marker] to cdc task config

```
[data_marker]
topo_name=topo1
topo_nodes=node1,node2
src_node=node1
dst_node=node2
do_nodes=node1
ignore_nodes=node2
marker=ape_trans_mysql.topo1
```

- topo_name: defined by user, keep same in all tasks
- topo_nodes: node names in topology, defined by user, keep same in all tasks, this field is reserved and has not been used yet
- src_node: source node of the current task
- dst_node: target node of the current task
- do_nodes: if the data is originated from these nodes, task will sync it to the target
- ignore_nodes: if the data is originated from these nodes, task will ignore it
- marker: data marker table, defined by user, keep same in all tasks



# Example: mysql_to_mysql
- An example for two-way data sync

## node1 -> node2
```
[data_marker]
topo_name=topo1
topo_nodes=node1,node2
src_node=node1
dst_node=node2
do_nodes=node1
ignore_nodes=node2
marker=ape_trans_mysql.topo1
```

## node2 -> node1
```
[data_marker]
topo_name=topo1
topo_nodes=node1,node2
src_node=node2
dst_node=node1
do_nodes=node2
ignore_nodes=node1
marker=ape_trans_mysql.topo1
```

# Other configs
- Refer to task_config.ini in cycle-related tests:
    - dt-tests/tests/mysql_to_mysql/cdc
    - dt-tests/tests/pg_to_pg/cdc
    - dt-tests/tests/redis_to_redis/cdc